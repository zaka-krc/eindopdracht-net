<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:SuntoryManagementSystem_App.ViewModels"
             xmlns:converters="clr-namespace:SuntoryManagementSystem_App.Converters"
             xmlns:models="clr-namespace:SuntoryManagementSystem.Models;assembly=SuntoryManagementSystem_Models"
             x:Class="SuntoryManagementSystem_App.Pages.DeliveryPage"
             x:DataType="viewmodels:DeliveryViewModel"
             Title="Leveringen"
             BackgroundColor="White">

    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        <converters:DeliveryStatusColorConverter x:Key="DeliveryStatusColorConverter" />
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*" Padding="20">
        
        <!-- HEADER SECTIE -->
        <VerticalStackLayout Grid.Row="0" Spacing="15">
            
            <!-- Zoekbalk -->
            <Border BackgroundColor="#F5F5F5"
                    StrokeThickness="0">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10"/>
                </Border.StrokeShape>
                
                <SearchBar Placeholder="Zoek leveringen op referentie, partner, notities..."
                           Text="{Binding ZoekTekst}"
                           BackgroundColor="Transparent"/>
            </Border>
            
            <!-- Filters Grid -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                <!-- Type Filter -->
                <Border Grid.Column="0"
                        BackgroundColor="#F5F5F5"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10"/>
                    </Border.StrokeShape>
                    <Picker Title="Type"
                            SelectedItem="{Binding GeselecteerdType}"
                            BackgroundColor="Transparent">
                        <Picker.ItemsSource>
                            <x:Array Type="{x:Type x:String}">
                                <x:String>Alle</x:String>
                                <x:String>Incoming</x:String>
                                <x:String>Outgoing</x:String>
                            </x:Array>
                        </Picker.ItemsSource>
                    </Picker>
                </Border>
                
                <!-- Status Filter -->
                <Border Grid.Column="1"
                        BackgroundColor="#F5F5F5"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10"/>
                    </Border.StrokeShape>
                    <Picker Title="Status"
                            SelectedItem="{Binding GeselecteerdeStatus}"
                            BackgroundColor="Transparent">
                        <Picker.ItemsSource>
                            <x:Array Type="{x:Type x:String}">
                                <x:String>Alle</x:String>
                                <x:String>Gepland</x:String>
                                <x:String>Delivered</x:String>
                                <x:String>Geannuleerd</x:String>
                            </x:Array>
                        </Picker.ItemsSource>
                    </Picker>
                </Border>
            </Grid>
            
            <!-- Action Buttons -->
            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                <Button Grid.Column="0"
                        x:Name="BtnNieuw"
                        Text="+ Nieuwe Levering"
                        FontSize="16"
                        FontAttributes="Bold"
                        BackgroundColor="#28a745"
                        TextColor="White"
                        HeightRequest="50"
                        CornerRadius="10"
                        Clicked="OnNieuwClicked"/>
                
                <Button Grid.Column="1"
                        x:Name="BtnRefresh"
                        Text="Vernieuwen"
                        FontSize="14"
                        BackgroundColor="#512BD4"
                        TextColor="White"
                        WidthRequest="110"
                        HeightRequest="50"
                        CornerRadius="10"
                        Clicked="OnRefreshClicked"/>
            </Grid>
        </VerticalStackLayout>

        <!-- LEVERINGEN LIJST -->
        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsRefreshing}"
                     Refreshing="OnRefreshViewRefreshing">
            <ScrollView>
                <VerticalStackLayout Spacing="0">
                    
                    <!-- Loading Indicator -->
                    <ActivityIndicator IsRunning="{Binding IsLoading}"
                                     IsVisible="{Binding IsLoading}"
                                     Color="#512BD4"
                                     WidthRequest="50"
                                     HeightRequest="50"
                                     Margin="0,20,0,0"
                                     VerticalOptions="Center"
                                     HorizontalOptions="Center"/>
                    
                    <!-- Leveringen CollectionView -->
                    <CollectionView ItemsSource="{Binding GefilterdeLeveringen}"
                                  IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                                  SelectionMode="None">
                        
                        <CollectionView.EmptyView>
                            <VerticalStackLayout Padding="20"
                                               VerticalOptions="Center"
                                               HorizontalOptions="Center">
                                <Label Text="Geen leveringen gevonden"
                                     FontSize="18"
                                     FontAttributes="Bold"
                                     TextColor="Gray"
                                     HorizontalOptions="Center"/>
                                <Label Text="Voeg een levering toe of pas je zoekfilter aan"
                                     FontSize="14"
                                     TextColor="Gray"
                                     HorizontalOptions="Center"
                                     Margin="0,10,0,0"/>
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>
                        
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Delivery">
                                <Border Padding="15"
                                        Margin="0,5"
                                        BackgroundColor="#F8F9FA"
                                        StrokeThickness="0">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="10"/>
                                    </Border.StrokeShape>
                                    
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnCardTapped"/>
                                    </Border.GestureRecognizers>
                                    
                                    <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto,Auto,Auto">
                                        
                                        <!-- Reference Number -->
                                        <Label Grid.Row="0" Grid.Column="0"
                                               Text="{Binding ReferenceNumber}"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               TextColor="#212121"/>
                                        
                                        <!-- Status Badge -->
                                        <Border Grid.Row="0" Grid.Column="1"
                                                BackgroundColor="{Binding Status, Converter={StaticResource DeliveryStatusColorConverter}}"
                                                Padding="8,4"
                                                StrokeThickness="0">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="12"/>
                                            </Border.StrokeShape>
                                            <Label Text="{Binding Status}"
                                                   TextColor="White"
                                                   FontSize="12"
                                                   FontAttributes="Bold"/>
                                        </Border>
                                        
                                        <!-- Delivery Type -->
                                        <HorizontalStackLayout Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                                             Spacing="5"
                                                             Margin="0,5,0,0">
                                            <Label Text="Type:"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   TextColor="#666"/>
                                            <Label Text="{Binding DeliveryType}"
                                                   FontSize="14"
                                                   TextColor="#666"/>
                                        </HorizontalStackLayout>
                                        
                                        <!-- Partner & Date Info -->
                                        <Grid Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                              ColumnDefinitions="*,*"
                                              Margin="0,5,0,0">
                                            
                                            <VerticalStackLayout Grid.Column="0" Spacing="2">
                                                <Label Text="Partner"
                                                       FontSize="11"
                                                       TextColor="Gray"/>
                                                <Label Text="{Binding PartnerName}"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       TextColor="#424242"/>
                                            </VerticalStackLayout>
                                            
                                            <VerticalStackLayout Grid.Column="1" Spacing="2">
                                                <Label Text="Verwachte datum"
                                                       FontSize="11"
                                                       TextColor="Gray"/>
                                                <Label Text="{Binding ExpectedDeliveryDate, StringFormat='{0:dd-MM-yyyy}'}"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       TextColor="#424242"/>
                                            </VerticalStackLayout>
                                        </Grid>
                                        
                                        <!-- Total Amount & Processed Status -->
                                        <Grid Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" 
                                              ColumnDefinitions="*,Auto"
                                              Margin="0,10,0,0">
                                            
                                            <VerticalStackLayout Grid.Column="0" Spacing="2">
                                                <Label Text="Totaalbedrag"
                                                       FontSize="11"
                                                       TextColor="Gray"/>
                                                <Label Text="{Binding TotalAmount, StringFormat='EUR {0:F2}'}"
                                                       FontSize="18"
                                                       FontAttributes="Bold"
                                                       TextColor="#16A34A"/>
                                            </VerticalStackLayout>
                                            
                                            <!-- Verwerkt Badge -->
                                            <Border Grid.Column="1"
                                                    BackgroundColor="#d4edda"
                                                    Stroke="#28a745"
                                                    StrokeThickness="2"
                                                    Padding="10,5"
                                                    VerticalOptions="Center"
                                                    IsVisible="{Binding IsProcessed}">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="8"/>
                                                </Border.StrokeShape>
                                                <HorizontalStackLayout Spacing="5">
                                                    <Label Text="âœ“"
                                                           FontSize="16"
                                                           FontAttributes="Bold"
                                                           TextColor="#28a745"
                                                           VerticalOptions="Center"/>
                                                    <Label Text="Verwerkt"
                                                           FontSize="13"
                                                           FontAttributes="Bold"
                                                           TextColor="#28a745"
                                                           VerticalOptions="Center"/>
                                                </HorizontalStackLayout>
                                            </Border>
                                        </Grid>
                                        
                                        <!-- Action Buttons - Consistent met andere pages -->
                                        <Grid Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2"
                                              ColumnDefinitions="*,Auto,Auto"
                                              Margin="0,10,0,0">
                                            
                                            <!-- Spacer voor alignment -->
                                            <BoxView Grid.Column="0" IsVisible="False"/>
                                            
                                            <!-- Edit Button -->
                                            <Button Grid.Column="1"
                                                    Text="Bewerken"
                                                    FontSize="14"
                                                    BackgroundColor="#ffc107"
                                                    TextColor="White"
                                                    WidthRequest="95"
                                                    HeightRequest="45"
                                                    CornerRadius="8"
                                                    Padding="0"
                                                    Margin="0,0,5,0"
                                                    Clicked="OnDetailsClicked"/>
                                            
                                            <!-- Delete Button -->
                                            <Button Grid.Column="2"
                                                    Text="Verwijder"
                                                    FontSize="14"
                                                    BackgroundColor="#dc3545"
                                                    TextColor="White"
                                                    WidthRequest="95"
                                                    HeightRequest="45"
                                                    CornerRadius="8"
                                                    Padding="0"
                                                    Clicked="OnSwipeVerwijderInvoked"/>
                                        </Grid>
                                        
                                        <!-- Type Indicator -->
                                        <BoxView Grid.Row="0" Grid.RowSpan="5" Grid.Column="0"
                                                WidthRequest="4"
                                                HorizontalOptions="Start"
                                                Color="{Binding Status, Converter={StaticResource DeliveryStatusColorConverter}}"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>
    </Grid>
</ContentPage>
