@model SuntoryManagementSystem.Models.Delivery

@{
    ViewData["Title"] = "Levering Bewerken";
    bool isReadOnly = Model.IsProcessed || Model.Status == "Geannuleerd";
}

<div class="container-fluid px-4">
    <!-- Page Header -->
    <div class="page-header page-header-warning shadow-soft mb-4">
        <div class="container-fluid px-4">
            <h1 class="display-5 fw-bold mb-2">
                <i class="bi bi-pencil-square me-3"></i>Levering Bewerken
            </h1>
            <p class="mb-0 opacity-75">Bewerk de gegevens van de levering</p>
            @if (isReadOnly)
            {
                <div class="alert alert-warning mt-3 mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Deze levering kan niet meer worden bewerkt omdat deze al @(Model.IsProcessed ? "verwerkt" : "geannuleerd") is.
                </div>
            }
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="form-modern">
                <form asp-action="Edit" method="post" id="deliveryForm">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger rounded-custom" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    </div>
                    <input type="hidden" asp-for="DeliveryId" />
                    <input type="hidden" asp-for="CreatedDate" />
                    <input type="hidden" asp-for="IsDeleted" />
                    <input type="hidden" asp-for="DeletedDate" />

                    <!-- Basic Information -->
                    <div class="mb-4">
                        <h4 class="fw-bold text-gradient mb-3">
                            <i class="bi bi-info-circle me-2"></i>Basis Informatie
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="DeliveryType" class="form-label">
                                    <i class="bi bi-box-seam me-1"></i>Levering Type
                                </label>
                                <select asp-for="DeliveryType" class="form-select" id="deliveryTypeSelect" disabled="@isReadOnly">
                                    <option value="Incoming">Incoming (Inkoop van leverancier)</option>
                                    <option value="Outgoing">Outgoing (Verkoop naar klant)</option>
                                </select>
                                <span asp-validation-for="DeliveryType" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="ReferenceNumber" class="form-label">
                                    <i class="bi bi-tag me-1"></i>Referentienummer
                                </label>
                                <input asp-for="ReferenceNumber" class="form-control" readonly="@isReadOnly" />
                                <span asp-validation-for="ReferenceNumber" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Party Information -->
                    <div class="mb-4">
                        <h4 class="fw-bold text-gradient mb-3">
                            <i class="bi bi-people me-2"></i>Partijen
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-6" id="supplierSection">
                                <label asp-for="SupplierId" class="form-label">
                                    <i class="bi bi-shop me-1"></i>Leverancier
                                </label>
                                <select asp-for="SupplierId" class="form-select" asp-items="ViewBag.SupplierId" disabled="@isReadOnly">
                                    <option value="">-- Selecteer Leverancier --</option>
                                </select>
                                <span asp-validation-for="SupplierId" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6" id="customerSection">
                                <label asp-for="CustomerId" class="form-label">
                                    <i class="bi bi-person me-1"></i>Klant
                                </label>
                                <select asp-for="CustomerId" class="form-select" asp-items="ViewBag.CustomerId" disabled="@isReadOnly">
                                    <option value="">-- Selecteer Klant --</option>
                                </select>
                                <span asp-validation-for="CustomerId" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="VehicleId" class="form-label">
                                    <i class="bi bi-car-front me-1"></i>Voertuig (optioneel)
                                </label>
                                <select asp-for="VehicleId" class="form-select" asp-items="ViewBag.VehicleId" disabled="@isReadOnly">
                                    <option value="">-- Selecteer Voertuig --</option>
                                </select>
                                <span asp-validation-for="VehicleId" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Details -->
                    <div class="mb-4">
                        <h4 class="fw-bold text-gradient mb-3">
                            <i class="bi bi-calendar-check me-2"></i>Levering Details
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="ExpectedDeliveryDate" class="form-label">
                                    <i class="bi bi-calendar me-1"></i>Verwachte Leverdatum
                                </label>
                                <input asp-for="ExpectedDeliveryDate" class="form-control" type="datetime-local" readonly="@isReadOnly" />
                                <span asp-validation-for="ExpectedDeliveryDate" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Status" class="form-label">
                                    <i class="bi bi-circle-fill me-1"></i>Status
                                </label>
                                <select asp-for="Status" class="form-select" disabled="@isReadOnly">
                                    <option value="Gepland">Gepland</option>
                                    <option value="Delivered">Delivered</option>
                                    <option value="Geannuleerd">Geannuleerd</option>
                                </select>
                                <span asp-validation-for="Status" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Items Section -->
                    <div class="mb-4">
                        <h4 class="fw-bold text-gradient mb-3">
                            <i class="bi bi-box-seam me-2"></i>Producten
                        </h4>
                        
                        @if (!isReadOnly)
                        {
                            <!-- Add Product Form -->
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-4">
                                            <label for="productSelect" class="form-label">Product</label>
                                            <select id="productSelect" class="form-select">
                                                <option value="">-- Selecteer Product --</option>
                                                @if (ViewBag.Products != null)
                                                {
                                                    foreach (var product in ViewBag.Products)
                                                    {
                                                        <option value="@product.ProductId" 
                                                                data-name="@product.ProductName" 
                                                                data-purchase="@product.PurchasePrice" 
                                                                data-selling="@product.SellingPrice"
                                                                data-stock="@product.StockQuantity">
                                                            @product.ProductName (Voorraad: @product.StockQuantity)
                                                        </option>
                                                    }
                                                }
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="quantityInput" class="form-label">Hoeveelheid</label>
                                            <input type="number" id="quantityInput" class="form-control" min="1" value="1" />
                                        </div>
                                        <div class="col-md-3">
                                            <label for="unitPriceInput" class="form-label">Prijs per stuk (€)</label>
                                            <input type="number" id="unitPriceInput" class="form-control" step="0.01" min="0" value="0.00" />
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-primary w-100" id="addItemBtn">
                                                <i class="bi bi-plus-circle me-1"></i>Toevoegen
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- Items List -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="itemsTable">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Hoeveelheid</th>
                                        <th>Prijs/stuk</th>
                                        <th>Totaal</th>
                                        @if (!isReadOnly)
                                        {
                                            <th style="width: 100px;">Actie</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody">
                                    @if (Model.DeliveryItems != null && Model.DeliveryItems.Any())
                                    {
                                        var itemIndex = 0;
                                        foreach (var item in Model.DeliveryItems.Where(di => !di.IsDeleted))
                                        {
                                            <tr data-item-id="@itemIndex">
                                                <td>@item.Product?.ProductName</td>
                                                <td>@item.Quantity</td>
                                                <td>€ @item.UnitPrice.ToString("F2")</td>
                                                <td>€ @item.Total.ToString("F2")</td>
                                                @if (!isReadOnly)
                                                {
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(@itemIndex)">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </td>
                                                }
                                                <input type="hidden" name="DeliveryItems[@itemIndex].ProductId" value="@item.ProductId" />
                                                <input type="hidden" name="DeliveryItems[@itemIndex].Quantity" value="@item.Quantity" />
                                                <input type="hidden" name="DeliveryItems[@itemIndex].UnitPrice" value="@item.UnitPrice" />
                                            </tr>
                                            itemIndex++;
                                        }
                                    }
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3" class="text-end"><strong>Totaalbedrag:</strong></td>
                                        <td colspan="@(isReadOnly ? "1" : "2")"><strong id="totalAmount">€ @Model.TotalAmount.ToString("F2")</strong></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <!-- Hidden field for total amount -->
                        <input type="hidden" asp-for="TotalAmount" id="totalAmountInput" />
                    </div>

                    <!-- Additional Information -->
                    <div class="mb-4">
                        <h4 class="fw-bold text-gradient mb-3">
                            <i class="bi bi-sticky me-2"></i>Aanvullende Informatie
                        </h4>
                        <div class="row g-3">
                            <div class="col-12">
                                <label asp-for="Notes" class="form-label">
                                    <i class="bi bi-sticky me-1"></i>Notities
                                </label>
                                <textarea asp-for="Notes" class="form-control" rows="4" readonly="@isReadOnly"></textarea>
                                <span asp-validation-for="Notes" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex gap-3 justify-content-end border-top pt-4 mt-4">
                        <a asp-action="Index" class="btn btn-lg btn-secondary">
                            <i class="bi bi-x-circle me-2"></i>@(isReadOnly ? "Terug" : "Annuleren")</a>
                        @if (!isReadOnly)
                        {
                            <button type="submit" class="btn btn-lg btn-warning text-white">
                                <i class="bi bi-check-circle-fill me-2"></i>Wijzigingen Opslaan
                            </button>
                        }
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // Array to store delivery items
        let deliveryItems = [];
        let itemCounter = @(Model.DeliveryItems?.Count(di => !di.IsDeleted) ?? 0);
        
        // Load existing items into array
        @if (Model.DeliveryItems != null && Model.DeliveryItems.Any())
        {
            var itemIndex = 0;
            foreach (var item in Model.DeliveryItems.Where(di => !di.IsDeleted))
            {
                <text>
                deliveryItems.push({
                    id: @itemIndex,
                    productId: @item.ProductId,
                    productName: '@Html.Raw(item.Product?.ProductName ?? "Unknown")',
                    quantity: @item.Quantity,
                    unitPrice: @item.UnitPrice,
                    total: @item.Total
                });
                </text>
                itemIndex++;
            }
        }

        $(document).ready(function() {
            // Update supplier/customer visibility based on delivery type
            $('#deliveryTypeSelect').change(function() {
                updatePartnerVisibility();
            });

            // Update price when product is selected
            $('#productSelect').change(function() {
                updatePrice();
            });

            // Add item button click
            $('#addItemBtn').click(function() {
                addDeliveryItem();
            });

            // Initialize visibility
            updatePartnerVisibility();
        });

        function updatePartnerVisibility() {
            const deliveryType = $('#deliveryTypeSelect').val();
            
            if (deliveryType === 'Incoming') {
                $('#supplierSection').show();
                $('#customerSection').hide();
                $('#CustomerId').val('');
            } else {
                $('#supplierSection').hide();
                $('#customerSection').show();
                $('#SupplierId').val('');
            }
        }

        function updatePrice() {
            const selectedOption = $('#productSelect option:selected');
            const deliveryType = $('#deliveryTypeSelect').val();
            
            if (selectedOption.val()) {
                const purchasePrice = parseFloat(selectedOption.data('purchase')) || 0;
                const sellingPrice = parseFloat(selectedOption.data('selling')) || 0;
                const price = deliveryType === 'Incoming' ? purchasePrice : sellingPrice;
                
                $('#unitPriceInput').val(price.toFixed(2));
            }
        }

        function addDeliveryItem() {
            const productSelect = $('#productSelect');
            const selectedOption = productSelect.find('option:selected');
            const quantity = parseInt($('#quantityInput').val()) || 0;
            const unitPrice = parseFloat($('#unitPriceInput').val()) || 0;
            
            // Validation
            if (!selectedOption.val()) {
                alert('Selecteer een product!');
                return;
            }
            
            if (quantity <= 0) {
                alert('Voer een geldige hoeveelheid in!');
                return;
            }
            
            if (unitPrice < 0) {
                alert('Voer een geldige prijs in!');
                return;
            }

            const productId = selectedOption.val();
            const productName = selectedOption.data('name');
            const stock = parseInt(selectedOption.data('stock')) || 0;
            const deliveryType = $('#deliveryTypeSelect').val();

            // Check stock for outgoing deliveries
            if (deliveryType === 'Outgoing') {
                const alreadyInList = deliveryItems
                    .filter(item => item.productId === productId)
                    .reduce((sum, item) => sum + item.quantity, 0);
                
                const totalRequested = alreadyInList + quantity;
                
                if (totalRequested > stock) {
                    alert(`ONVOLDOENDE VOORRAAD!\n\n` +
                          `Product: ${productName}\n` +
                          `Beschikbare voorraad: ${stock}\n` +
                          `Al in levering: ${alreadyInList}\n` +
                          `Probeer toe te voegen: ${quantity}\n` +
                          `Totaal gevraagd: ${totalRequested}\n\n` +
                          `Je kunt maximaal ${stock - alreadyInList} stuks toevoegen.`);
                    return;
                }
            }
            
            const total = quantity * unitPrice;
            
            // Add item to array
            const item = {
                id: itemCounter++,
                productId: productId,
                productName: productName,
                quantity: quantity,
                unitPrice: unitPrice,
                total: total
            };
            
            deliveryItems.push(item);
            
            // Add row to table
            addItemRow(item);
            
            // Update total
            updateTotal();
            
            // Reset form
            $('#quantityInput').val('1');
            updatePrice();
        }

        function addItemRow(item) {
            const row = `
                <tr data-item-id="${item.id}">
                    <td>${item.productName}</td>
                    <td>${item.quantity}</td>
                    <td>€ ${item.unitPrice.toFixed(2)}</td>
                    <td>€ ${item.total.toFixed(2)}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(${item.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <input type="hidden" name="DeliveryItems[${item.id}].ProductId" value="${item.productId}" />
                    <input type="hidden" name="DeliveryItems[${item.id}].Quantity" value="${item.quantity}" />
                    <input type="hidden" name="DeliveryItems[${item.id}].UnitPrice" value="${item.unitPrice}" />
                </tr>
            `;
            
            $('#itemsTableBody').append(row);
        }

        function removeItem(itemId) {
            // Remove from array
            deliveryItems = deliveryItems.filter(item => item.id !== itemId);
            
            // Remove row
            $(`tr[data-item-id="${itemId}"]`).remove();
            
            // Update total
            updateTotal();
        }

        function updateTotal() {
            const total = deliveryItems.reduce((sum, item) => sum + item.total, 0);
            $('#totalAmount').text('€ ' + total.toFixed(2));
            $('#totalAmountInput').val(total.toFixed(2));
        }

        // Form submission validation
        $('#deliveryForm').submit(function(e) {
            if (deliveryItems.length === 0) {
                e.preventDefault();
                alert('Voeg minimaal één product toe aan de levering!');
                return false;
            }
            return true;
        });
    </script>
}
